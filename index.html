<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWC Project Financial Projection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .table-container {
            max-width: 1200px;
            margin: 2rem auto;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }
        .table-header {
            background-color: #1f2937;
            color: white;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #374151;
        }
        .table-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .table-header p {
            font-size: 0.875rem;
            color: #9ca3af;
        }
        .actions-bar {
            background-color: #fff;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 0.75rem;
        }
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #f9fafb;
            color: #374151;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .action-btn:hover {
            background-color: #f3f4f6;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .category-header td {
            background-color: #e5e7eb;
            font-weight: 700;
            color: #1f2937;
        }
        .total-row td {
            font-weight: 700;
            background-color: #f9fafb;
        }
        .profit-row td {
            background-color: #d1fae5;
            color: #065f46;
            font-size: 1.125rem;
            font-weight: 700;
        }
        .loss-row td {
            background-color: #fee2e2;
            color: #991b1b;
            font-size: 1.125rem;
            font-weight: 700;
        }
        input[type="number"] {
            width: 120px;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            text-align: right;
            transition: border-color 0.2s;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .currency::before {
            content: 'SAR ';
            color: #6b7280;
        }
        .summary-card {
            background-color: #f9fafb;
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        .summary-item {
            text-align: center;
            padding: 1rem;
        }
        .summary-item .label {
            font-size: 0.875rem;
            color: #4b5563;
            font-weight: 500;
        }
        .summary-item .value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }
        .summary-item .value.total-revenue { color: #16a34a; }
        .summary-item .value.total-cost { color: #dc2626; }
        .summary-item .value.net-profit { color: #059669; }
        .summary-item .value.net-loss { color: #b91c1c; }

        @media print {
            body {
                background-color: #fff;
            }
            .table-container {
                margin: 0;
                box-shadow: none;
                border: none;
            }
            .table-header, .actions-bar, .summary-card {
                display: none;
            }
            input[type="number"] {
                border: none;
                padding: 0;
                -moz-appearance: textfield;
            }
            input::-webkit-outer-spin-button,
            input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            .currency::before {
                content: '';
            }
            td, th {
                padding: 0.5rem;
                font-size: 10pt;
            }
        }
    </style>
</head>
<body>

    <div class="table-container">
        <div class="table-header">
            <h1>NWC Project Financial Projection</h1>
            <p>Enter project values to calculate revenue, costs, and profit. All values in Saudi Riyal (SAR).</p>
        </div>

        <div class="actions-bar">
            <button id="export-btn" class="action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                Export to Excel (.csv)
            </button>
            <button id="print-btn" class="action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                Print to PDF
            </button>
        </div>

        <div id="summary" class="summary-card">
            <div class="summary-item">
                <div class="label">Total Revenue</div>
                <div id="summary-revenue" class="value total-revenue">SAR 0.00</div>
            </div>
            <div class="summary-item">
                <div class="label">Total Cost</div>
                <div id="summary-cost" class="value total-cost">SAR 0.00</div>
            </div>
            <div class="summary-item">
                <div class="label">Net Profit / Loss</div>
                <div id="summary-profit" class="value">SAR 0.00</div>
            </div>
        </div>

        <table id="financial-table">
            <thead>
                <tr>
                    <th>Item / Role</th>
                    <th>Description / Headcount</th>
                    <th>Unit Cost / Revenue</th>
                    <th>Quantity / Months</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- Revenue Section -->
                <tr class="category-header">
                    <td colspan="5">1. Project Revenue</td>
                </tr>
                <tr>
                    <td>Pipe Work Installation</td>
                    <td>Revenue per meter of pipe work</td>
                    <td class="currency"><input type="number" id="revenue-pipe-per-meter" value="0" oninput="calculateAll()"></td>
                    <td><input type="number" id="qty-pipe-meters" value="1000" oninput="calculateAll()"></td>
                    <td class="currency" id="total-revenue-pipe">0.00</td>
                </tr>
                <tr>
                    <td>Water Meter Installation</td>
                    <td>Revenue per installed water meter</td>
                    <td class="currency"><input type="number" id="revenue-water-meter" value="3000" oninput="calculateAll()"></td>
                    <td><input type="number" id="qty-water-meters" value="50" oninput="calculateAll()"></td>
                    <td class="currency" id="total-revenue-water-meter">150,000.00</td>
                </tr>
                <tr class="total-row">
                    <td colspan="4">Total Revenue</td>
                    <td class="currency" id="total-revenue">150,000.00</td>
                </tr>

                <!-- Monthly Recurring Costs Section -->
                <tr class="category-header">
                    <td colspan="5">2. Monthly Recurring Costs (Per Team)</td>
                </tr>
                <!-- Personnel -->
                <tr>
                    <td>Supervisor</td>
                    <td>1</td>
                    <td class="currency"><input type="number" id="cost-supervisor" value="8500" oninput="calculateAll()"></td>
                    <td><input type="number" class="qty" id="months-personnel" value="12" oninput="calculateAll()"></td>
                    <td class="currency" id="total-supervisor">102,000.00</td>
                </tr>
                <tr>
                    <td>Plumber</td>
                    <td>1</td>
                    <td class="currency"><input type="number" id="cost-plumber" value="7000" oninput="calculateAll()"></td>
                    <td class="ref-qty" data-ref="months-personnel">12</td>
                    <td class="currency" id="total-plumber">84,000.00</td>
                </tr>
                <tr>
                    <td>Driver</td>
                    <td>1</td>
                    <td class="currency"><input type="number" id="cost-driver" value="6000" oninput="calculateAll()"></td>
                    <td class="ref-qty" data-ref="months-personnel">12</td>
                    <td class="currency" id="total-driver">72,000.00</td>
                </tr>
                <tr>
                    <td>Laborer</td>
                    <td>4</td>
                    <td class="currency"><input type="number" id="cost-laborer" value="5500" oninput="calculateAll()"></td>
                    <td class="ref-qty" data-ref="months-personnel">12</td>
                    <td class="currency" id="total-laborer">264,000.00</td>
                </tr>
                <!-- Machinery Rental -->
                 <tr>
                    <td>JCB Backhoe Loader</td>
                    <td>1 (Monthly Rental)</td>
                    <td class="currency"><input type="number" id="cost-jcb" value="12000" oninput="calculateAll()"></td>
                    <td class="ref-qty" data-ref="months-personnel">12</td>
                    <td class="currency" id="total-jcb">144,000.00</td>
                </tr>
                 <tr>
                    <td>Dump Truck</td>
                    <td>1 (Monthly Rental)</td>
                    <td class="currency"><input type="number" id="cost-dumptruck" value="6000" oninput="calculateAll()"></td>
                    <td class="ref-qty" data-ref="months-personnel">12</td>
                    <td class="currency" id="total-dumptruck">72,000.00</td>
                </tr>
                <tr class="total-row">
                    <td colspan="4">Total Recurring Costs</td>
                    <td class="currency" id="total-recurring-costs">738,000.00</td>
                </tr>

                <!-- Capital & Variable Costs Section -->
                <tr class="category-header">
                    <td colspan="5">3. Capital & Variable Costs</td>
                </tr>
                <tr>
                    <td>"Dina" Truck</td>
                    <td>Purchase or Lease</td>
                    <td class="currency"><input type="number" id="cost-dina" value="0" oninput="calculateAll()"></td>
                    <td>1</td>
                    <td class="currency" id="total-dina">0.00</td>
                </tr>
                <tr>
                    <td>Safety Equipment</td>
                    <td>Signs, lighting, permits, PPE</td>
                    <td class="currency"><input type="number" id="cost-safety" value="0" oninput="calculateAll()"></td>
                    <td>1</td>
                    <td class="currency" id="total-safety">0.00</td>
                </tr>
                <tr>
                    <td>Pipes (e.g., Ductile Iron)</td>
                    <td>Total length required for project</td>
                    <td class="currency"><input type="number" id="cost-pipes" value="0" oninput="calculateAll()"></td>
                    <td><input type="number" class="qty" id="qty-pipes" value="1" oninput="calculateAll()"></td>
                    <td class="currency" id="total-pipes">0.00</td>
                </tr>
                <tr>
                    <td>Valves & Fittings</td>
                    <td>Copper/Brass valves, elbows, sleeves</td>
                    <td class="currency"><input type="number" id="cost-fittings" value="0" oninput="calculateAll()"></td>
                    <td><input type="number" class="qty" id="qty-fittings" value="1" oninput="calculateAll()"></td>
                    <td class="currency" id="total-fittings">0.00</td>
                </tr>
                <tr>
                    <td>Water Meters</td>
                    <td>Quantity of meters to be installed/replaced</td>
                    <td class="currency"><input type="number" id="cost-meters" value="0" oninput="calculateAll()"></td>
                    <td><input type="number" class="qty" id="qty-meters" value="50" oninput="calculateAll()"></td>
                    <td class="currency" id="total-meters">0.00</td>
                </tr>
                <tr>
                    <td>General Tools & Consumables</td>
                    <td>Miscellaneous tools and supplies</td>
                    <td class="currency"><input type="number" id="cost-tools" value="0" oninput="calculateAll()"></td>
                    <td>1</td>
                    <td class="currency" id="total-tools">0.00</td>
                </tr>
                <tr>
                    <td>Soil Testing</td>
                    <td>Per-site certified lab tests</td>
                    <td class="currency"><input type="number" id="cost-soil" value="0" oninput="calculateAll()"></td>
                    <td><input type="number" class="qty" id="qty-soil" value="10" oninput="calculateAll()"></td>
                    <td class="currency" id="total-soil">0.00</td>
                </tr>
                <tr>
                    <td>Waste Disposal</td>
                    <td>Per-site soil disposal (Variable)</td>
                    <td class="currency"><input type="number" id="cost-waste" value="0" oninput="calculateAll()"></td>
                    <td><input type="number" class="qty" id="qty-waste" value="50" oninput="calculateAll()"></td>
                    <td class="currency" id="total-waste">0.00</td>
                </tr>
                <tr class="total-row">
                    <td colspan="4">Total Capital & Variable Costs</td>
                    <td class="currency" id="total-variable-costs">0.00</td>
                </tr>

                <!-- Grand Total Section -->
                <tr class="category-header">
                    <td colspan="5">4. Project Financial Summary</td>
                </tr>
                <tr class="total-row">
                    <td colspan="4">Total Project Cost</td>
                    <td class="currency" id="total-project-cost">738,000.00</td>
                </tr>
                <tr id="profit-loss-row">
                    <td colspan="4">Net Profit / Loss</td>
                    <td class="currency" id="net-profit-loss">-588,000.00</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // --- CALCULATION LOGIC ---
        function formatCurrency(num) {
            return parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function calculateAll() {
            // --- REVENUE CALCULATION ---
            const revenuePipePerMeter = parseFloat(document.getElementById('revenue-pipe-per-meter').value) || 0;
            const qtyPipeMeters = parseFloat(document.getElementById('qty-pipe-meters').value) || 0;
            const totalRevenuePipe = revenuePipePerMeter * qtyPipeMeters;
            document.getElementById('total-revenue-pipe').textContent = formatCurrency(totalRevenuePipe);

            const revenueWaterMeter = parseFloat(document.getElementById('revenue-water-meter').value) || 0;
            const qtyWaterMeters = parseFloat(document.getElementById('qty-water-meters').value) || 0;
            const totalRevenueWaterMeter = revenueWaterMeter * qtyWaterMeters;
            document.getElementById('total-revenue-water-meter').textContent = formatCurrency(totalRevenueWaterMeter);

            const totalRevenue = totalRevenuePipe + totalRevenueWaterMeter;
            document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);


            // --- RECURRING COSTS CALCULATION ---
            const months = parseFloat(document.getElementById('months-personnel').value) || 0;
            document.querySelectorAll('.ref-qty').forEach(el => { el.textContent = months; });

            const costSupervisor = parseFloat(document.getElementById('cost-supervisor').value) || 0;
            document.getElementById('total-supervisor').textContent = formatCurrency(costSupervisor * months);
            const costPlumber = parseFloat(document.getElementById('cost-plumber').value) || 0;
            document.getElementById('total-plumber').textContent = formatCurrency(costPlumber * months);
            const costDriver = parseFloat(document.getElementById('cost-driver').value) || 0;
            document.getElementById('total-driver').textContent = formatCurrency(costDriver * months);
            const costLaborer = parseFloat(document.getElementById('cost-laborer').value) || 0;
            document.getElementById('total-laborer').textContent = formatCurrency(costLaborer * 4 * months);
            const costJcb = parseFloat(document.getElementById('cost-jcb').value) || 0;
            document.getElementById('total-jcb').textContent = formatCurrency(costJcb * months);
            const costDumpTruck = parseFloat(document.getElementById('cost-dumptruck').value) || 0;
            document.getElementById('total-dumptruck').textContent = formatCurrency(costDumpTruck * months);

            const totalRecurringCosts = (costSupervisor + costPlumber + costDriver + (costLaborer * 4) + costJcb + costDumpTruck) * months;
            document.getElementById('total-recurring-costs').textContent = formatCurrency(totalRecurringCosts);
            
            // --- VARIABLE COSTS CALCULATION ---
            const costDina = parseFloat(document.getElementById('cost-dina').value) || 0;
            document.getElementById('total-dina').textContent = formatCurrency(costDina);
            const costSafety = parseFloat(document.getElementById('cost-safety').value) || 0;
            document.getElementById('total-safety').textContent = formatCurrency(costSafety);
            const costPipes = parseFloat(document.getElementById('cost-pipes').value) || 0;
            const qtyPipes = parseFloat(document.getElementById('qty-pipes').value) || 0;
            document.getElementById('total-pipes').textContent = formatCurrency(costPipes * qtyPipes);
            const costFittings = parseFloat(document.getElementById('cost-fittings').value) || 0;
            const qtyFittings = parseFloat(document.getElementById('qty-fittings').value) || 0;
            document.getElementById('total-fittings').textContent = formatCurrency(costFittings * qtyFittings);
            const costMeters = parseFloat(document.getElementById('cost-meters').value) || 0;
            const qtyMeters = parseFloat(document.getElementById('qty-meters').value) || 0;
            document.getElementById('total-meters').textContent = formatCurrency(costMeters * qtyMeters);
            const costTools = parseFloat(document.getElementById('cost-tools').value) || 0;
            document.getElementById('total-tools').textContent = formatCurrency(costTools);
            const costSoil = parseFloat(document.getElementById('cost-soil').value) || 0;
            const qtySoil = parseFloat(document.getElementById('qty-soil').value) || 0;
            document.getElementById('total-soil').textContent = formatCurrency(costSoil * qtySoil);
            const costWaste = parseFloat(document.getElementById('cost-waste').value) || 0;
            const qtyWaste = parseFloat(document.getElementById('qty-waste').value) || 0;
            document.getElementById('total-waste').textContent = formatCurrency(costWaste * qtyWaste);

            const totalVariableCosts = costDina + costSafety + (costPipes * qtyPipes) + (costFittings * qtyFittings) + (costMeters * qtyMeters) + costTools + (costSoil * qtySoil) + (costWaste * qtyWaste);
            document.getElementById('total-variable-costs').textContent = formatCurrency(totalVariableCosts);

            // --- SUMMARY CALCULATION ---
            const totalProjectCost = totalRecurringCosts + totalVariableCosts;
            document.getElementById('total-project-cost').textContent = formatCurrency(totalProjectCost);

            const netProfitLoss = totalRevenue - totalProjectCost;
            document.getElementById('net-profit-loss').textContent = formatCurrency(netProfitLoss);

            // Update summary cards
            document.getElementById('summary-revenue').textContent = 'SAR ' + formatCurrency(totalRevenue);
            document.getElementById('summary-cost').textContent = 'SAR ' + formatCurrency(totalProjectCost);
            document.getElementById('summary-profit').textContent = 'SAR ' + formatCurrency(netProfitLoss);

            // --- STYLING ---
            const profitRow = document.getElementById('profit-loss-row');
            const summaryProfit = document.getElementById('summary-profit');
            profitRow.className = netProfitLoss >= 0 ? 'profit-row' : 'loss-row';
            summaryProfit.className = 'value ' + (netProfitLoss >= 0 ? 'net-profit' : 'net-loss');
        }

        // --- EVENT LISTENERS ---
        document.getElementById('print-btn').addEventListener('click', () => {
            window.print();
        });

        document.getElementById('export-btn').addEventListener('click', () => {
            const table = document.getElementById('financial-table');
            let csv = [];
            
            // Add summary data first
            const totalRevenue = document.getElementById('summary-revenue').textContent;
            const totalCost = document.getElementById('summary-cost').textContent;
            const netProfit = document.getElementById('summary-profit').textContent;
            csv.push(`"NWC Project Financial Summary"`);
            csv.push(`"Total Revenue","${totalRevenue}"`);
            csv.push(`"Total Cost","${totalCost}"`);
            csv.push(`"Net Profit / Loss","${netProfit}"`);
            csv.push(''); // Add a blank line for spacing

            for (const row of table.rows) {
                const rowData = [];
                for (const cell of row.cells) {
                    let cellText = cell.innerText;
                    if (cell.querySelector('input[type="number"]')) {
                        cellText = cell.querySelector('input[type="number"]').value;
                    }
                    // Escape double quotes by doubling them and wrap the content in quotes
                    rowData.push(`"${cellText.replace(/"/g, '""')}"`);
                }
                csv.push(rowData.join(','));
            }

            const csvContent = "data:text/csv;charset=utf-8," + csv.join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "NWC_Financial_Projection.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        window.onload = calculateAll;
    </script>

</body>
</html>