<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWC Project Financial Projection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .table-container {
            width: 100%;
            max-width: 1200px;
            margin: 1rem auto;
        }
        @media (min-width: 640px) {
            .table-container {
                margin: 2rem auto;
            }
        }
        .table-wrapper {
            overflow-x: auto;
        }
        .table-header {
            background-color: #1f2937;
            color: white;
        }
        .info-bar {
            background-color: #374151;
            color: #d1d5db;
        }
        .info-bar input {
            background: transparent;
            border: none;
            color: white;
        }
        .actions-bar {
            background-color: #fff;
        }
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #f9fafb;
            color: #374151;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .action-btn:hover {
            background-color: #f3f4f6;
        }
        .action-btn.primary {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .action-btn.primary:hover {
            background-color: #1d4ed8;
        }
        table {
            width: 100%;
            min-width: 700px; /* Ensures table has a minimum width before scrolling */
            border-collapse: collapse;
        }
        /* Hide the first column (Frequency) */
        th:first-child, td:first-child {
            display: none;
        }
        th, td {
            padding: 0.75rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .category-header td {
            background-color: #e5e7eb;
            font-weight: 700;
            color: #1f2937;
        }
        .total-row td {
            font-weight: 700;
            background-color: #f9fafb;
        }
        .profit-row td {
            background-color: #d1fae5;
            color: #065f46;
            font-size: 1.125rem;
            font-weight: 700;
        }
        .loss-row td {
            background-color: #fee2e2;
            color: #991b1b;
            font-size: 1.125rem;
            font-weight: 700;
        }
        input[type="number"], input[type="text"], input[type="password"] {
            width: 100px;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            text-align: right;
            transition: border-color 0.2s;
        }
        input[type="number"]:focus, input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .currency::before {
            content: 'SAR ';
            color: #6b7280;
        }
        .summary-card {
            background-color: #f9fafb;
        }
        .summary-item .label {
            font-size: 0.875rem;
            color: #4b5563;
            font-weight: 500;
        }
        .summary-item .value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }
        .summary-item .value.total-revenue { color: #16a34a; }
        .summary-item .value.total-cost { color: #dc2626; }
        .summary-item .value.net-profit { color: #059669; }
        .summary-item .value.net-loss { color: #b91c1c; }
        
        /* Modal & Login Styles */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .login-box {
            background: white;
            padding: 2.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        @media print {
            body { background-color: #fff; }
            .table-container { margin: 0; box-shadow: none; border: none; }
            .table-header, .actions-bar, .summary-card, .overlay { display: none; }
            input[type="number"] { border: none; padding: 0; -moz-appearance: textfield; }
            input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
            .currency::before { content: ''; }
            td, th { padding: 0.5rem; font-size: 10pt; }
        }
    </style>
</head>
<body>

    <div id="login-overlay" class="overlay">
        <div class="login-box">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Project Login</h2>
            <div class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full !text-left">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full !text-left">
                </div>
                <p id="login-error" class="text-sm text-red-600 hidden">Invalid username or password.</p>
                <button id="login-btn" class="w-full action-btn primary justify-center !py-2.5 !text-base">Login</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="table-container bg-white rounded-lg shadow-lg overflow-hidden hidden">
        <div class="table-header p-4 sm:p-6">
            <h1 class="text-xl sm:text-2xl font-bold">NWC Project Financial Projection</h1>
            <p class="text-sm mt-1">Enter project values to calculate revenue, costs, and profit. All values in Saudi Riyal (SAR).</p>
            <p class="text-sm text-green-400 mt-1">Data is synced in real-time for all users.</p>
        </div>
        
        <div class="info-bar flex flex-wrap items-center gap-x-4 gap-y-2 p-3 sm:p-2">
            <div class="flex items-center">Date: <input type="text" id="record-date" class="w-32" readonly></div>
            <div class="flex items-center flex-grow">Location: <input type="text" id="record-location" class="w-full min-w-[300px]" placeholder="Not captured" readonly></div>
            <button id="get-location-btn" class="action-btn !bg-gray-200 !text-gray-800 hover:!bg-gray-300 !py-1 !px-3">Get Location</button>
        </div>

        <div class="actions-bar flex flex-wrap items-center gap-2 p-3 sm:p-4">
            <button id="save-record-btn" class="action-btn primary">Save Record</button>
            <button id="view-records-btn" class="action-btn">View Saved Records</button>
            <button id="manage-users-btn" class="action-btn hidden">Manage Users</button>
            <button id="export-btn" class="action-btn">Export to Excel (.csv)</button>
            <button id="print-btn" class="action-btn">Print to PDF</button>
        </div>

        <div id="summary" class="summary-card grid grid-cols-1 sm:grid-cols-3 gap-4 p-4 border-b border-gray-200">
            <div class="summary-item text-center p-4">
                <div class="label">Total Revenue</div>
                <div id="summary-revenue" class="value total-revenue">SAR 0.00</div>
            </div>
            <div class="summary-item text-center p-4">
                <div class="label">Total Cost</div>
                <div id="summary-cost" class="value total-cost">SAR 0.00</div>
            </div>
            <div class="summary-item text-center p-4">
                <div class="label">Net Profit / Loss</div>
                <div id="summary-profit" class="value">SAR 0.00</div>
            </div>
        </div>
        
        <div class="table-wrapper">
            <table id="financial-table">
                <thead>
                    <tr>
                        <th>Frequency</th>
                        <th>Category</th>
                        <th>Item / Role</th>
                        <th>Qty</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr><td colspan="5" class="text-center p-8">Please log in to start.</td></tr>
                </tbody>
                <tfoot>
                    <tr class="total-row" style="background-color: #e5e7eb;">
                        <td></td>
                        <td colspan="4" class="font-bold text-lg">Total Project Cost</td>
                        <td id="total-project-cost" class="font-bold text-lg currency">0.00</td>
                    </tr>
                    <tr id="profit-loss-row">
                        <td></td>
                        <td colspan="4" class="font-bold text-lg">Net Profit / Loss</td>
                        <td id="net-profit-loss" class="font-bold text-lg currency">0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Modals -->
    <div id="records-modal" class="overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Saved Records</h2>
                <button class="modal-close-btn" onclick="window.closeModal('records-modal')">&times;</button>
            </div>
            <div id="records-list"></div>
        </div>
    </div>
    <div id="users-modal" class="overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>User Management</h2>
                <button class="modal-close-btn" onclick="window.closeModal('users-modal')">&times;</button>
            </div>
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Add New User</h3>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div class="flex-grow">
                            <label for="new-username" class="block text-sm font-medium text-gray-700">Username</label>
                            <input type="text" id="new-username" class="mt-1 block w-full !text-left">
                        </div>
                        <div class="flex-grow">
                            <label for="new-mobile" class="block text-sm font-medium text-gray-700">Mobile Number</label>
                            <input type="text" id="new-mobile" class="mt-1 block w-full !text-left">
                        </div>
                        <button id="add-user-btn" class="action-btn primary">Add User</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Existing Users</h3>
                    <div id="users-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Generic Modal for alerts, confirms, prompts -->
    <div id="generic-modal" class="overlay hidden">
        <div class="modal-content max-w-sm">
            <h3 id="modal-title" class="text-lg font-medium text-gray-900 mb-4"></h3>
            <div id="modal-text" class="text-sm text-gray-600 mb-4"></div>
            <div id="modal-prompt-input-container" class="hidden mb-4">
                 <label id="modal-prompt-label" for="modal-prompt-input" class="block text-sm font-medium text-gray-700"></label>
                 <input type="text" id="modal-prompt-input" class="mt-1 block w-full !text-left">
            </div>
            <div id="modal-buttons" class="flex justify-end gap-4"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB_PWfver0TH_a5vtTIRXYZj1kMRiEKH08",
            authDomain: "nwc-project-db.firebaseapp.com",
            projectId: "nwc-project-db",
            storageBucket: "nwc-project-db.appspot.com",
            messagingSenderId: "603492098201",
            appId: "1:603492098201:web:ba6e9ed8519534cc0e1808"
        };
        
        let db, auth;
        let projectionDocRef, savedRecordsColRef, usersColRef;

        const defaultData = [
            { freq: 'Revenue per Site', cat: 'Revenue', item: 'Apator water meter', qty: 5, price: 3200, type: 'revenue' },
            { freq: 'Revenue per Site', cat: 'Revenue', item: 'Additional Meter', qty: 150, price: 165, type: 'revenue' },
            { freq: 'One time Cost', cat: 'Tools & Equipments', item: 'Molder', qty: 1, price: 10000, type: 'cost' },
            { freq: 'One time Cost', cat: 'Tools & Equipments', item: 'Plastic Blocks', qty: 30, price: 105, type: 'cost' },
            { freq: 'One time Cost', cat: 'Tools & Equipments', item: 'LED', qty: 3, price: 3, type: 'cost' },
            { freq: 'One time Cost', cat: 'Tools & Equipments', item: 'Extention cable', qty: 1, price: 100, type: 'cost' },
            { freq: 'One time Cost', cat: 'Tools & Equipments', item: 'PPE', qty: 7, price: 60, type: 'cost' },
            { freq: 'One time Cost', cat: 'Tools & Equipments', item: 'Tablet', qty: 2, price: 5000, type: 'cost' },
            { freq: 'One time Cost', cat: 'Tools & Equipments', item: 'Sim', qty: 2, price: 1000, type: 'cost' },
            { freq: 'Monthly Cost', cat: 'Salaries', item: 'Site Engineer', qty: 1, price: 7500, type: 'cost' },
            { freq: 'Monthly Cost', cat: 'Salaries', item: 'Plumber', qty: 1, price: 4500, type: 'cost' },
            { freq: 'Monthly Cost', cat: 'Salaries', item: 'Site Supervisor', qty: 1, price: 4000, type: 'cost' },
            { freq: 'Monthly Cost', cat: 'Salaries', item: 'Labour', qty: 4, price: 3000, type: 'cost' },
            { freq: 'Monthly Cost', cat: 'Machinary', item: 'JCB', qty: 1, price: 12000, type: 'cost' },
            { freq: 'Monthly Cost', cat: 'Machinary', item: 'Dump Truck', qty: 1, price: 6000, type: 'cost' },
            { freq: 'Monthly Cost', cat: 'Team Transport', item: 'Car & Gas', qty: 2, price: 5000, type: 'cost' },
            { freq: 'Monthly Cost', cat: 'Team Transport', item: 'Van & Gas', qty: 1, price: 5000, type: 'cost' },
            { freq: 'Cost per Site', cat: 'Works', item: 'Street Paving', qty: 5, price: 1000, type: 'cost' },
            { freq: 'Cost per Site', cat: 'Works', item: 'Harary', qty: 5, price: 50, type: 'cost' },
            { freq: 'Cost per Site', cat: 'Works', item: 'Valves', qty: 5, price: 1000, type: 'cost' },
            { freq: 'Cost per Site', cat: 'Works', item: 'Pipes Length (m)', qty: 5, price: 30, type: 'cost' },
            { freq: 'Cost per Site', cat: 'Works', item: 'Soil Testing', qty: 5, price: 200, type: 'cost' },
        ];

        let modalResolve;
        function showModal({ type = 'alert', title, text, promptLabel = '' }) {
            const modal = document.getElementById('generic-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').innerHTML = text.replace(/\n/g, '<br>');
            const buttonsEl = document.getElementById('modal-buttons');
            const promptContainer = document.getElementById('modal-prompt-input-container');
            const promptInput = document.getElementById('modal-prompt-input');
            buttonsEl.innerHTML = '';
            promptContainer.classList.add('hidden');

            if (type === 'alert') {
                buttonsEl.innerHTML = `<button class="action-btn primary">OK</button>`;
                buttonsEl.querySelector('button').onclick = () => closeModal(true);
            } else if (type === 'confirm') {
                buttonsEl.innerHTML = `<button class="action-btn">Cancel</button><button class="action-btn primary">OK</button>`;
                buttonsEl.querySelector('.primary').onclick = () => closeModal(true);
                buttonsEl.querySelector('.action-btn:not(.primary)').onclick = () => closeModal(false);
            } else if (type === 'prompt') {
                document.getElementById('modal-prompt-label').textContent = promptLabel;
                promptInput.value = '';
                promptContainer.classList.remove('hidden');
                buttonsEl.innerHTML = `<button class="action-btn">Cancel</button><button class="action-btn primary">Save</button>`;
                buttonsEl.querySelector('.primary').onclick = () => closeModal(promptInput.value);
                buttonsEl.querySelector('.action-btn:not(.primary)').onclick = () => closeModal(null);
                setTimeout(() => promptInput.focus(), 100);
            }
            modal.classList.remove('hidden');
            return new Promise(resolve => { modalResolve = resolve; });
        }

        function closeModal(value) {
            document.getElementById('generic-modal').classList.add('hidden');
            if (modalResolve) modalResolve(value);
        }

        function formatCurrency(num) {
            return parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        async function updateDataInFirestore() {
            const dataToSave = [];
            document.getElementById('table-body').querySelectorAll('tr[data-type]').forEach(row => {
                 dataToSave.push({
                    freq: row.dataset.freq, cat: row.cells[1].innerText, item: row.cells[2].innerText,
                    qty: parseFloat(row.querySelector('.qty-input').value) || 0,
                    price: parseFloat(row.querySelector('.price-input').value) || 0,
                    type: row.dataset.type,
                });
            });
            try { await setDoc(projectionDocRef, { data: dataToSave }); } 
            catch (error) { console.error("Error updating document: ", error); }
        }
        
        function handleLocalInput() {
            calculateAll();
            updateDataInFirestore();
        }
        window.handleLocalInput = handleLocalInput;

        function calculateAll() {
            let totalRevenue = 0, totalCost = 0;
            document.getElementById('table-body').querySelectorAll('tr[data-type]').forEach(row => {
                const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                const total = qty * price;
                row.querySelector('.total-cell').textContent = formatCurrency(total);
                if (row.dataset.type === 'revenue') totalRevenue += total;
                else totalCost += total;
            });
            const netProfitLoss = totalRevenue - totalCost;
            document.getElementById('summary-revenue').textContent = 'SAR ' + formatCurrency(totalRevenue);
            document.getElementById('summary-cost').textContent = 'SAR ' + formatCurrency(totalCost);
            document.getElementById('summary-profit').textContent = 'SAR ' + formatCurrency(netProfitLoss);
            document.getElementById('total-project-cost').textContent = formatCurrency(totalCost);
            document.getElementById('net-profit-loss').textContent = formatCurrency(netProfitLoss);
            const profitRow = document.getElementById('profit-loss-row');
            const summaryProfit = document.getElementById('summary-profit');
            profitRow.className = netProfitLoss >= 0 ? 'profit-row' : 'loss-row';
            summaryProfit.className = 'value ' + (netProfitLoss >= 0 ? 'net-profit' : 'net-loss');
        }

        function renderTable(data) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = ''; 
            let lastFreq = '';
            data.forEach(d => {
                if (d.freq !== lastFreq) {
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'category-header';
                    headerRow.innerHTML = `<td></td><td colspan="5">${d.freq}</td>`;
                    tableBody.appendChild(headerRow);
                    lastFreq = d.freq;
                }
                const row = document.createElement('tr');
                row.dataset.type = d.type; row.dataset.freq = d.freq;
                row.innerHTML = `
                    <td>${d.freq}</td> <td>${d.cat}</td> <td>${d.item}</td>
                    <td><input type="number" class="qty-input" value="${d.qty}" oninput="window.handleLocalInput()"></td>
                    <td class="currency"><input type="number" class="price-input" value="${d.price}" oninput="window.handleLocalInput()"></td>
                    <td class="currency total-cell">0.00</td>
                `;
                tableBody.appendChild(row);
            });
            calculateAll();
        }

        function setupEventListeners() {
            document.getElementById('print-btn').addEventListener('click', () => window.print());
            document.getElementById('export-btn').addEventListener('click', exportToCsv);
            document.getElementById('get-location-btn').addEventListener('click', getLocation);
            document.getElementById('save-record-btn').addEventListener('click', saveRecord);
            document.getElementById('view-records-btn').addEventListener('click', openRecordsModal);
            document.getElementById('manage-users-btn').addEventListener('click', openUsersModal);
            document.getElementById('add-user-btn').addEventListener('click', addUser);
        }

        function setDate() {
            const dateField = document.getElementById('record-date');
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear().toString().slice(-2);
            dateField.value = `${day}.${month}.${year}`;
        }

        function getLocation() {
            const locationField = document.getElementById('record-location');
            if (navigator.geolocation) {
                locationField.value = "Fetching...";
                navigator.geolocation.getCurrentPosition(
                    (p) => { locationField.value = `${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)}`; },
                    () => { locationField.value = "Unable to retrieve location."; }
                );
            } else { locationField.value = "Geolocation not supported."; }
        }

        async function saveRecord() {
            const recordName = await showModal({ type: 'prompt', title: 'Save Record', text: 'Enter a name for this record.', promptLabel: 'Record Name' });
            if (!recordName) return;
            const recordData = [];
            document.getElementById('table-body').querySelectorAll('tr[data-type]').forEach(row => {
                recordData.push({
                    freq: row.dataset.freq, cat: row.cells[1].innerText, item: row.cells[2].innerText,
                    qty: parseFloat(row.querySelector('.qty-input').value) || 0,
                    price: parseFloat(row.querySelector('.price-input').value) || 0,
                    type: row.dataset.type,
                });
            });
            try {
                await addDoc(savedRecordsColRef, { name: recordName, data: recordData, createdAt: new Date() });
                await showModal({ type: 'alert', title: 'Success', text: `Record "${recordName}" saved.` });
            } catch (error) { await showModal({ type: 'alert', title: 'Error', text: "Failed to save record." }); }
        }

        window.closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');
        window.openModal = (modalId) => document.getElementById(modalId).classList.remove('hidden');

        async function openRecordsModal() {
            const listContainer = document.getElementById('records-list');
            listContainer.innerHTML = '<p>Loading records...</p>';
            openModal('records-modal');
            try {
                const querySnapshot = await getDocs(savedRecordsColRef);
                listContainer.innerHTML = '';
                if (querySnapshot.empty) { listContainer.innerHTML = '<p>No saved records found.</p>'; }
                else {
                    querySnapshot.forEach(doc => {
                        const record = doc.data();
                        const item = document.createElement('div');
                        item.className = 'record-item';
                        item.innerHTML = `<span>${record.name}</span> <div class="flex gap-2"> <button class="action-btn" onclick="window.loadRecord('${doc.id}')">Load</button> <button class="action-btn" style="background-color: #ef4444; color: white;" onclick="window.deleteRecord('${doc.id}')">Delete</button> </div>`;
                        listContainer.appendChild(item);
                    });
                }
            } catch (error) { listContainer.innerHTML = '<p>Could not load records.</p>'; }
        }

        window.loadRecord = async (id) => {
            try {
                const docRef = doc(savedRecordsColRef, id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const recordToLoad = docSnap.data();
                    await setDoc(projectionDocRef, { data: recordToLoad.data });
                    closeModal('records-modal');
                    await showModal({ type: 'alert', title: 'Success', text: `Record "${recordToLoad.name}" loaded.` });
                }
            } catch (error) { await showModal({ type: 'alert', title: 'Error', text: "Failed to load record." }); }
        };

        window.deleteRecord = async (id) => {
            const confirmed = await showModal({ type: 'confirm', title: 'Delete Record', text: "Are you sure you want to delete this record?" });
            if (!confirmed) return;
            try {
                await deleteDoc(doc(savedRecordsColRef, id));
                openRecordsModal();
            } catch (error) { await showModal({ type: 'alert', title: 'Error', text: "Failed to delete record." }); }
        };
        
        function exportToCsv() {
            let csv = [];
            csv.push(`"NWC Project Financial Summary"`);
            csv.push(`"Date","${document.getElementById('record-date').value}"`);
            csv.push(`"Location","${document.getElementById('record-location').value}"`);
            csv.push(`"Total Revenue","${document.getElementById('summary-revenue').textContent}"`);
            csv.push(`"Total Cost","${document.getElementById('summary-cost').textContent}"`);
            csv.push(`"Net Profit / Loss","${document.getElementById('summary-profit').textContent}"`);
            csv.push('');
            csv.push(`"Frequency","Category","Item / Role","Qty","Unit Price","Total"`);
            document.getElementById('table-body').querySelectorAll('tr[data-type]').forEach(row => {
                const rowData = [
                    `"${row.dataset.freq}"`, `"${row.cells[1].innerText}"`, `"${row.cells[2].innerText}"`,
                    `"${row.cells[3].querySelector('input').value}"`, `"${row.cells[4].querySelector('input').value}"`,
                    `"${row.cells[5].innerText.replace(/,/g, '')}"`
                ];
                csv.push(rowData.join(','));
            });
            const csvContent = "data:text/csv;charset=utf-8," + csv.join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "NWC_Financial_Projection.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function handleLogin() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');
            
            const users = await getDocs(usersColRef).then(snap => snap.docs.map(d => ({...d.data(), id: d.id})));
            const validUser = users.find(u => u.username === user && u.password === pass);

            if (validUser) {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                if (validUser.role === 'admin') {
                    document.getElementById('manage-users-btn').classList.remove('hidden');
                }
                startApp();
            } else {
                errorMsg.classList.remove('hidden');
            }
        }
        
        async function startApp() {
            onSnapshot(projectionDocRef, (docSnap) => {
                if (docSnap.metadata.hasPendingWrites) return;
                if (docSnap.exists()) { renderTable(docSnap.data().data); } 
                else { setDoc(projectionDocRef, { data: defaultData }).then(() => renderTable(defaultData)); }
            }, (error) => {
                console.error("Error listening to document:", error);
                document.getElementById('table-body').innerHTML = '<tr><td colspan="5" class="text-center p-8 text-red-500">Connection error.</td></tr>';
            });
            setupEventListeners();
            setDate();
        }

        async function initializeLogin() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            await signInAnonymously(auth);
            
            const basePath = `nwc-projections/live`;
            usersColRef = collection(db, `${basePath}/users`);
            projectionDocRef = doc(db, `${basePath}/projection_data/current_state`);
            savedRecordsColRef = collection(db, `${basePath}/saved_records`);

            const usersSnap = await getDocs(usersColRef);
            if (usersSnap.empty) {
                await addDoc(usersColRef, { username: 'admin', password: 'password123', role: 'admin', mobile: 'N/A' });
                await addDoc(usersColRef, { username: 'user', password: 'user123', role: 'user', mobile: 'N/A' });
            }
        }

        async function addUser() {
            const username = document.getElementById('new-username').value;
            const mobile = document.getElementById('new-mobile').value;
            if (!username || !mobile) {
                await showModal({ type: 'alert', title: 'Input Required', text: 'Please provide a username and mobile number.' });
                return;
            }
            const password = Math.random().toString(36).slice(-8);
            try {
                await addDoc(usersColRef, { username, password, mobile, role: 'user' });
                await showModal({ type: 'alert', title: 'User Created', text: `User "${username}" created.\nPassword: <b>${password}</b>\n\nNOTE: Please share these details manually.` });
                document.getElementById('new-username').value = '';
                document.getElementById('new-mobile').value = '';
                openUsersModal();
            } catch (e) { await showModal({ type: 'alert', title: 'Error', text: 'Failed to add user.' }); }
        }

        async function openUsersModal() {
            const listContainer = document.getElementById('users-list');
            listContainer.innerHTML = '<p>Loading users...</p>';
            openModal('users-modal');
            const users = await getDocs(usersColRef).then(snap => snap.docs.map(d => ({...d.data(), id: d.id})));
            listContainer.innerHTML = '';
            users.filter(u => u.role !== 'admin').forEach(user => {
                const item = document.createElement('div');
                item.className = 'record-item';
                item.innerHTML = `
                    <div>
                        <p class="font-medium">${user.username}</p>
                        <p class="text-sm text-gray-500">${user.mobile}</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="action-btn" onclick="window.resetPassword('${user.id}', '${user.username}')">Reset Password</button>
                        <button class="action-btn" style="background-color: #ef4444; color: white;" onclick="window.deleteUser('${user.id}')">Delete</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }
        
        window.resetPassword = async (id, username) => {
            const confirmed = await showModal({ type: 'confirm', title: 'Reset Password', text: `Are you sure you want to reset the password for ${username}?` });
            if (!confirmed) return;
            const newPassword = Math.random().toString(36).slice(-8);
            try {
                await updateDoc(doc(usersColRef, id), { password: newPassword });
                await showModal({ type: 'alert', title: 'Password Reset', text: `Password for "${username}" has been reset.\nNew Password: <b>${newPassword}</b>\n\nNOTE: Please share this manually.` });
            } catch (e) { await showModal({ type: 'alert', title: 'Error', text: 'Failed to reset password.' }); }
        }

        window.deleteUser = async (id) => {
            const confirmed = await showModal({ type: 'confirm', title: 'Delete User', text: "Are you sure you want to delete this user?" });
            if (!confirmed) return;
            try {
                await deleteDoc(doc(usersColRef, id));
                openUsersModal();
            } catch (e) { await showModal({ type: 'alert', title: 'Error', text: "Failed to delete user." }); }
        }

        document.getElementById('login-btn').addEventListener('click', handleLogin);
        initializeLogin();

    </script>

</body>
</html>
